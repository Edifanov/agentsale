FROM php:5.6-fpm

MAINTAINER Aleksey Shirokih <aleksei.shirokikh@domru.ru>

RUN apt-get update \
    && apt-get -y install \
            git \
            g++ \
            libicu-dev \
            libmcrypt-dev \
            zlib1g-dev \
            libldap2-dev \
            libfreetype6-dev \
            libjpeg62-turbo-dev \
            libmcrypt-dev \
            libpng12-dev \
            libcurl4-gnutls-dev \
            libmemcached-dev \
            libmagickwand-6.q16-dev \
            curl \
        --no-install-recommends \

# Install PHP extensions
    && docker-php-ext-configure gd --enable-gd-native-ttf \
                                   --with-jpeg-dir=/usr/lib/x86_64-linux-gnu \
                                   --with-png-dir=/usr/lib/x86_64-linux-gnu \
                                   --with-freetype-dir=/usr/lib/x86_64-linux-gnu \
    && docker-php-ext-install gd \

# Install LDAP
    && docker-php-ext-configure ldap --with-libdir=lib/x86_64-linux-gnu \
    && docker-php-ext-install ldap \

# Install other modules
    && docker-php-ext-install curl \
    && docker-php-ext-install gd \
    && docker-php-ext-install mcrypt \
    && docker-php-ext-install intl \
    && docker-php-ext-install pdo_mysql \
    && docker-php-ext-install mbstring \
    && docker-php-ext-install zip \

# Install ImageMagick
    && ln -s /usr/lib/x86_64-linux-gnu/ImageMagick-6.8.9/bin-Q16/MagickWand-config /usr/bin \
    && pecl install imagick \
    && echo "extension=imagick.so" > /usr/local/etc/php/conf.d/ext-imagick.ini \

# Install apcu
    && pecl install apcu-beta
    && echo 'extension = apcu.so' > /usr/local/etc/php/conf.d/apcu.ini \

# Install memcached
    && pecl install memcached && echo 'extension = memcached.so' > /usr/local/etc/php/conf.d/memcached.ini \

# clean pakages
    && apt-get purge -y g++ \
    && apt-get autoremove -y \
    && rm -r /var/lib/apt/lists/* \

# Don't clear our valuable environment vars in PHP
    && echo "\nclear_env = no" >> /usr/local/etc/php-fpm.conf \

# Fix write permissions with shared folders
    && usermod -u 1000 www-data

##<autogenerated>##
WORKDIR /var/www/html
COPY php-fpm.conf /usr/local/etc/

EXPOSE 9000
CMD ["php-fpm"]
##</autogenerated>##